rule rtf_cve2017_11882_ole : malicious exploit cve_2017_11882 hardened
{
	meta:
		author = "John Davison"
		description = "Attempts to identify the exploit CVE 2017 11882"
		reference = "https://embedi.com/blog/skeleton-closet-ms-office-vulnerability-you-didnt-know-about"
		sample = "51cf2a6c0c1a29abca9fd13cb22421da"
		score = 60

	strings:
		$headers = { 1c 00 00 00 02 00 ?? ?? a9 00 00 00 ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? 03 01 01 03 ?? }
		$font = { 0a 01 08 5a 5a }
		$winexec = { 12 0c 43 00 }

	condition:
		all of them and @font > @headers and @winexec == @font + 5 + 44
}

rule rtf_cve2017_11882 : malicious exploit cve_2017_1182 hardened
{
	meta:
		author = "John Davison"
		description = "Attempts to identify the exploit CVE 2017 11882"
		reference = "https://embedi.com/blog/skeleton-closet-ms-office-vulnerability-you-didnt-know-about"
		sample = "51cf2a6c0c1a29abca9fd13cb22421da"
		score = 60

	strings:
		$headers = { 31 63 30 30 30 30 30 30  30 32 30 30 ?? ?? ?? ??
                     61 39 30 30 30 30 30 30  ?? ?? ?? ?? ?? ?? ?? ??
                     ?? ?? ?? ?? ?? ?? ?? ??  ?? ?? ?? ?? ?? ?? ?? ??
                     ?? ?? ?? ?? ?? ?? ?? ??  30 33 30 31 30 31 30 33
                     ?? ?? }
		$font = { 30 61 30 31 30 38 35 61  35 61 }
		$winexec = { 31 32 30 63 34 33 30 30 }

	condition:
		all of them and @font > @headers and @winexec == @font + ( ( 5 + 44 ) * 2 )
}

rule packager_cve2017_11882 : hardened
{
	meta:
		author = "Rich Warren"
		description = "Attempts to exploit CVE-2017-11882 using Packager"
		reference = "https://github.com/rxwx/CVE-2017-11882/blob/master/packager_exec_CVE-2017-11882.py"
		score = 60
		id = "57ff395e-e56a-5e63-bde6-f3cef038fcd6"

	strings:
		$font = { 30 61 30 31 30 38 35 61  35 61 }
		$equation = { 45 71 75 61 74 69 6F 6E 2E 33 }
		$package = { 50 61 63 6b 61 67 65 }
		$header_and_shellcode = /03010[0,1][0-9a-fA-F]{108}00/ ascii nocase

	condition:
		uint32be( 0 ) == 0x7B5C7274 and all of them
}

rule CVE_2017_11882_RTF : hardened
{
	meta:
		description = "Detects suspicious Microsoft Equation OLE contents as used in CVE-2017-11882"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "Internal Research"
		date = "2018-02-13"
		score = 60
		id = "400689ff-e856-5cbf-a7fa-93f6a8d8dbb9"

	strings:
		$x1 = {34 64 35 33 34 38 35 34 34 31 32 65 34 35 35 38 34 35 32 30 36 38 37 34 37 34 37 30}
		$x2 = {36 64 37 33 36 38 37 34 36 31 32 65 36 35 37 38 36 35 32 30 36 38 37 34 37 34 37 30}
		$x3 = {36 64 37 33 36 38 37 34 36 31 32 30 36 38 37 34 37 34 37 30}
		$x4 = {34 64 35 33 34 38 35 34 34 31 32 30 36 38 37 34 37 34 37 30}
		$s1 = {34 64 36 39 36 33 37 32 36 66 37 33 36 66 36 36 37 34 32 30 34 35 37 31 37 35 36 31 37 34 36 39 36 66 36 65 32 30 33 33 32 65 33 30}
		$s2 = {34 35 30 30 37 31 30 30 37 35 30 30 36 31 30 30 37 34 30 30 36 39 30 30 36 66 30 30 36 65 30 30 32 30 30 30 34 65 30 30 36 31 30 30 37 34 30 30 36 39 30 30 37 36 30 30 36 35}
		$s3 = {32 65 36 38 37 34 36 31 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30}

	condition:
		( uint32be( 0 ) == 0x7B5C7274 or uint32be( 0 ) == 0x7B5C2A5C ) and filesize < 300KB and ( 1 of ( $x* ) or 2 of them )
}

