rule Linux_DirtyCow_Exploit : hardened limited
{
	meta:
		description = "Detects Linux Dirty Cow Exploit - CVE-2012-0056 and CVE-2016-5195"
		author = "Florian Roth"
		reference = "http://dirtycow.ninja/"
		date = "2016-10-21"
		score = 60

	strings:
		$a1 = { 48 89 D6 41 B9 00 00 00 00 41 89 C0 B9 02 00 00 00 BA 01 00 00 00 BF 00 00 00 00 }
		$b1 = { E8 ?? FC FF FF 48 8B 45 E8 BE 00 00 00 00 48 89 C7 E8 ?? FC FF FF 48 8B 45 F0 BE 00 00 00 00 48 89 }
		$b2 = { E8 ?? FC FF FF B8 00 00 00 00 }
		$source1 = {6d 61 64 76 69 73 65 28 6d 61 70 2c 31 30 30 2c 4d 41 44 56 5f 44 4f 4e 54 4e 45 45 44 29 3b}
		$source2 = {3d 6f 70 65 6e 28 22 2f 70 72 6f 63 2f 73 65 6c 66 2f 6d 65 6d 22 2c 4f 5f 52 44 57 52 29 3b}
		$source3 = {2c 6d 61 70 2c 53 45 45 4b 5f 53 45 54 29 3b}
		$source_printf1 = {6d 6d 61 70 20 25 78}
		$source_printf2 = {70 72 6f 63 73 65 6c 66 6d 65 6d 20 25 64}
		$source_printf3 = {6d 61 64 76 69 73 65 20 25 64}
		$source_printf4 = {5b 2d 5d 20 66 61 69 6c 65 64 20 74 6f 20 70 61 74 63 68 20 70 61 79 6c 6f 61 64}
		$source_printf5 = {5b 2d 5d 20 66 61 69 6c 65 64 20 74 6f 20 77 69 6e 20 72 61 63 65 20 63 6f 6e 64 69 74 69 6f 6e 2e 2e 2e}
		$source_printf6 = {5b 2a 5d 20 77 61 69 74 69 6e 67 20 66 6f 72 20 72 65 76 65 72 73 65 20 63 6f 6e 6e 65 63 74 20 73 68 65 6c 6c 2e 2e 2e}
		$s1 = {2f 70 72 6f 63 2f 73 65 6c 66 2f 6d 65 6d}
		$s2 = {2f 70 72 6f 63 2f 25 64 2f 6d 65 6d}
		$s3 = {2f 70 72 6f 63 2f 73 65 6c 66 2f 6d 61 70}
		$s4 = {2f 70 72 6f 63 2f 25 64 2f 6d 61 70}
		$p1 = {(bf | a1 | 21 | 22 | 23 | 24 | 25 | 26 | 27 | 28 | 29 | 2a | 2b | 2c | 2d | 2e | 2f | 3a | 3b | 3c | 3d | 3e | 3f | 40 | 5b | 5c | 5d | 5e | 5f | 60 | 7b | 7c | 7d | 7e | 20 | 09 | 0a | 0d | 0b | 0c | 00 | ff) 70 74 68 72 65 61 64 5f 63 72 65 61 74 65 (bf | a1 | 21 | 22 | 23 | 24 | 25 | 26 | 27 | 28 | 29 | 2a | 2b | 2c | 2d | 2e | 2f | 3a | 3b | 3c | 3d | 3e | 3f | 40 | 5b | 5c | 5d | 5e | 5f | 60 | 7b | 7c | 7d | 7e | 20 | 09 | 0a | 0d | 0b | 0c | 00 | ff)}
		$p2 = {(bf | a1 | 21 | 22 | 23 | 24 | 25 | 26 | 27 | 28 | 29 | 2a | 2b | 2c | 2d | 2e | 2f | 3a | 3b | 3c | 3d | 3e | 3f | 40 | 5b | 5c | 5d | 5e | 5f | 60 | 7b | 7c | 7d | 7e | 20 | 09 | 0a | 0d | 0b | 0c | 00 | ff) 70 74 68 72 65 61 64 5f 6a 6f 69 6e (bf | a1 | 21 | 22 | 23 | 24 | 25 | 26 | 27 | 28 | 29 | 2a | 2b | 2c | 2d | 2e | 2f | 3a | 3b | 3c | 3d | 3e | 3f | 40 | 5b | 5c | 5d | 5e | 5f | 60 | 7b | 7c | 7d | 7e | 20 | 09 | 0a | 0d | 0b | 0c | 00 | ff)}

	condition:
		( uint16( 0 ) == 0x457f and $a1 ) or all of ( $b* ) or 3 of ( $source* ) or ( uint16( 0 ) == 0x457f and 1 of ( $s* ) and all of ( $p* ) and filesize < 20KB )
}

