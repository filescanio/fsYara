rule PowerShell_Case_Anomaly : hardened loosened limited
{
	meta:
		description = "Detects obfuscated PowerShell hacktools"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://twitter.com/danielhbohannon/status/905096106924761088"
		date = "2017-08-11"
		modified = "2022-06-12"
		score = 70
		id = "41c97d15-c167-5bdd-a8b4-871d14f66fe1"

	strings:
		$s1 = {((70 6f 77 65 72 73 68 65 6c 6c) | (70 00 6f 00 77 00 65 00 72 00 73 00 68 00 65 00 6c 00 6c 00))}
		$sn1 = {((70 6f 77 65 72 73 68 65 6c 6c) | (70 00 6f 00 77 00 65 00 72 00 73 00 68 00 65 00 6c 00 6c 00))}
		$sn2 = {((50 6f 77 65 72 73 68 65 6c 6c) | (50 00 6f 00 77 00 65 00 72 00 73 00 68 00 65 00 6c 00 6c 00))}
		$sn3 = {((50 6f 77 65 72 53 68 65 6c 6c) | (50 00 6f 00 77 00 65 00 72 00 53 00 68 00 65 00 6c 00 6c 00))}
		$sn4 = {((50 4f 57 45 52 53 48 45 4c 4c) | (50 00 4f 00 57 00 45 00 52 00 53 00 48 00 45 00 4c 00 4c 00))}
		$sn5 = {((70 6f 77 65 72 53 68 65 6c 6c) | (70 00 6f 00 77 00 65 00 72 00 53 00 68 00 65 00 6c 00 6c 00))}
		$sn6 = {((50 6f 77 65 72 53 68 65 6c 4c) | (50 00 6f 00 77 00 65 00 72 00 53 00 68 00 65 00 6c 00 4c 00))}
		$sn7 = {((50 6f 77 65 72 73 68 65 6c 4c) | (50 00 6f 00 77 00 65 00 72 00 73 00 68 00 65 00 6c 00 4c 00))}
		$a1 = {((77 65 72 73 68 65 6c 6c 20 2d 65 20) | (77 00 65 00 72 00 73 00 68 00 65 00 6c 00 6c 00 20 00 2d 00 65 00 20 00))}
		$an1 = {((77 65 72 73 68 65 6c 6c 20 2d 65 20) | (77 00 65 00 72 00 73 00 68 00 65 00 6c 00 6c 00 20 00 2d 00 65 00 20 00))}
		$an2 = {((77 65 72 53 68 65 6c 6c 20 2d 65 20) | (77 00 65 00 72 00 53 00 68 00 65 00 6c 00 6c 00 20 00 2d 00 65 00 20 00))}
		$k1 = {((2d 6e 6f 70 72 6f 66 69 6c 65) | (2d 00 6e 00 6f 00 70 00 72 00 6f 00 66 00 69 00 6c 00 65 00))}
		$kn1 = {((2d 6e 6f 70 72 6f 66 69 6c 65) | (2d 00 6e 00 6f 00 70 00 72 00 6f 00 66 00 69 00 6c 00 65 00))}
		$kn2 = {((2d 4e 6f 50 72 6f 66 69 6c 65) | (2d 00 4e 00 6f 00 50 00 72 00 6f 00 66 00 69 00 6c 00 65 00))}
		$kn3 = {((2d 6e 6f 50 72 6f 66 69 6c 65) | (2d 00 6e 00 6f 00 50 00 72 00 6f 00 66 00 69 00 6c 00 65 00))}
		$kn4 = {((2d 4e 4f 50 52 4f 46 49 4c 45) | (2d 00 4e 00 4f 00 50 00 52 00 4f 00 46 00 49 00 4c 00 45 00))}
		$kn5 = {((2d 4e 6f 70 72 6f 66 69 6c 65) | (2d 00 4e 00 6f 00 70 00 72 00 6f 00 66 00 69 00 6c 00 65 00))}
		$fp1 = {(bf | a1 | 21 | 22 | 23 | 24 | 25 | 26 | 27 | 28 | 29 | 2a | 2b | 2c | 2d | 2e | 2f | 3a | 3b | 3c | 3d | 3e | 3f | 40 | 5b | 5c | 5d | 5e | 5f | 60 | 7b | 7c | 7d | 7e | 20 | 09 | 0a | 0d | 0b | 0c | 00 | ff) 4d 69 63 72 6f 73 6f 66 74 20 43 6f 64 65 20 53 69 67 6e 69 6e 67 (bf | a1 | 21 | 22 | 23 | 24 | 25 | 26 | 27 | 28 | 29 | 2a | 2b | 2c | 2d | 2e | 2f | 3a | 3b | 3c | 3d | 3e | 3f | 40 | 5b | 5c | 5d | 5e | 5f | 60 | 7b | 7c | 7d | 7e | 20 | 09 | 0a | 0d | 0b | 0c | 00 | ff)}
		$fp2 = {4d 69 63 72 6f 73 6f 66 74 20 43 6f 72 70 6f 72 61 74 69 6f 6e}
		$fp3 = {4d 00 69 00 63 00 72 00 6f 00 73 00 6f 00 66 00 74 00 2e 00 41 00 7a 00 75 00 72 00 65 00 2e 00 43 00 6f 00 6d 00 6d 00 61 00 6e 00 64 00 73 00 2e 00 43 00 6f 00 6e 00 74 00 61 00 69 00 6e 00 65 00 72 00 49 00 6e 00 73 00 74 00 61 00 6e 00 63 00 65 00}
		$fp4 = {23 00 20 00 4c 00 6f 00 63 00 61 00 6c 00 69 00 7a 00 65 00 64 00 20 00 50 00 53 00 47 00 65 00 74 00 2e 00 52 00 65 00 73 00 6f 00 75 00 72 00 63 00 65 00 2e 00 70 00 73 00 64 00 31 00}

	condition:
		filesize < 800KB and ( ( #s1 > #sn1 + #sn2 + #sn3 + #sn4 + #sn5 + #sn6 + #sn7 ) or ( #a1 > #an1 + #an2 ) or ( #k1 > #kn1 + #kn2 + #kn3 + #kn4 + #kn5 ) ) and not 1 of ( $fp* )
}

rule WScriptShell_Case_Anomaly : refined hardened limited
{
	meta:
		description = "Detects obfuscated wscript.shell commands"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "Internal Research"
		date = "2017-09-11"
		modified = "2022-06-09"
		score = 60
		id = "d69d932d-1e39-5259-9200-f0227754f49c"

	strings:
		$s1 = {((57 53 63 72 69 70 74 2e 53 68 65 6c 6c 22 29 2e 52 75 6e) | (57 00 53 00 63 00 72 00 69 00 70 00 74 00 2e 00 53 00 68 00 65 00 6c 00 6c 00 22 00 29 00 2e 00 52 00 75 00 6e 00))}
		$sn1 = {((57 53 63 72 69 70 74 2e 53 68 65 6c 6c 22 29 2e 52 75 6e) | (57 00 53 00 63 00 72 00 69 00 70 00 74 00 2e 00 53 00 68 00 65 00 6c 00 6c 00 22 00 29 00 2e 00 52 00 75 00 6e 00))}
		$sn2 = {((77 73 63 72 69 70 74 2e 73 68 65 6c 6c 22 29 2e 72 75 6e) | (77 00 73 00 63 00 72 00 69 00 70 00 74 00 2e 00 73 00 68 00 65 00 6c 00 6c 00 22 00 29 00 2e 00 72 00 75 00 6e 00))}
		$sn3 = {((57 53 43 52 49 50 54 2e 53 48 45 4c 4c 22 29 2e 52 55 4e) | (57 00 53 00 43 00 52 00 49 00 50 00 54 00 2e 00 53 00 48 00 45 00 4c 00 4c 00 22 00 29 00 2e 00 52 00 55 00 4e 00))}
		$sn4 = {((57 73 63 72 69 70 74 2e 53 68 65 6c 6c 22 29 2e 52 75 6e) | (57 00 73 00 63 00 72 00 69 00 70 00 74 00 2e 00 53 00 68 00 65 00 6c 00 6c 00 22 00 29 00 2e 00 52 00 75 00 6e 00))}
		$sn5 = {((57 53 63 72 69 70 74 2e 73 68 65 6c 6c 22 29 2e 52 75 6e) | (57 00 53 00 63 00 72 00 69 00 70 00 74 00 2e 00 73 00 68 00 65 00 6c 00 6c 00 22 00 29 00 2e 00 52 00 75 00 6e 00))}
		$sn6 = {((77 53 63 72 69 70 74 2e 53 68 65 6c 6c 22 29 2e 52 75 6e) | (77 00 53 00 63 00 72 00 69 00 70 00 74 00 2e 00 53 00 68 00 65 00 6c 00 6c 00 22 00 29 00 2e 00 52 00 75 00 6e 00))}

	condition:
		filesize < 3000KB and #s1 > #sn1 + #sn2 + #sn3 + #sn4 + #sn5 + #sn6
}

