rule Exploit_MS15_077_078 : hardened
{
	meta:
		description = "MS15-078 / MS15-077 exploit - generic signature"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://code.google.com/p/google-security-research/issues/detail?id=473&can=1&start=200"
		date = "2015-07-21"
		hash1 = "18e3e840a5e5b75747d6b961fca66a670e3faef252aaa416a88488967b47ac1c"
		hash2 = "0b5dc030e73074b18b1959d1cf7177ff510dbc2a0ec2b8bb927936f59eb3d14d"
		hash3 = "fc609adef44b5c64de029b2b2cff22a6f36b6bdf9463c1bd320a522ed39de5d9"
		hash4 = "ad6bb982a1ecfe080baf0a2b27950f989c107949b1cf02b6e0907f1a568ece15"
		id = "57f6db11-9d93-53fd-ab68-c6c3eadae2da"

	strings:
		$s1 = {47 44 49 33 32 2e 44 4c 4c}
		$s2 = {61 00 74 00 6d 00 66 00 64 00 2e 00 64 00 6c 00 6c 00}
		$s3 = {41 64 64 46 6f 6e 74 4d 65 6d 52 65 73 6f 75 72 63 65 45 78}
		$s4 = {4e 61 6d 65 64 45 73 63 61 70 65}
		$s5 = {43 72 65 61 74 65 42 69 74 6d 61 70}
		$s6 = {44 65 6c 65 74 65 4f 62 6a 65 63 74}
		$op0 = { 83 45 e8 01 eb 07 c7 45 e8 }
		$op1 = { 8d 85 24 42 fb ff 89 04 24 e8 80 22 00 00 c7 45 }
		$op2 = { eb 54 8b 15 6c 00 4c 00 8d 85 24 42 fb ff 89 44 }
		$op3 = { 64 00 88 ff 84 03 70 03 }

	condition:
		uint16( 0 ) == 0x5a4d and filesize < 2000KB and 5 of ( $s* ) or 3 of ( $op* )
}

rule Exploit_MS15_077_078_HackingTeam : hardened
{
	meta:
		description = "MS15-078 / MS15-077 exploit - Hacking Team code"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		date = "2015-07-21"
		super_rule = 1
		hash1 = "ad6bb982a1ecfe080baf0a2b27950f989c107949b1cf02b6e0907f1a568ece15"
		hash2 = "fc609adef44b5c64de029b2b2cff22a6f36b6bdf9463c1bd320a522ed39de5d9"
		id = "3bf40dec-c46e-5054-a98e-602049cb1824"

	strings:
		$s1 = {5c 53 79 73 74 65 6d 52 6f 6f 74 5c 73 79 73 74 65 6d 33 32 5c 43 49 2e 64 6c 6c}
		$s2 = {5c 73 79 73 6e 61 74 69 76 65 5c 43 49 2e 64 6c 6c}
		$s3 = {4d 6f 7a 69 6c 6c 61 2f 35 2e 30 20 28 57 69 6e 64 6f 77 73 20 4e 54 20 36 2e 31 3b 20 57 4f 57 36 34 29 20 41 70 70 6c 65 57 65 62 4b 69 74 2f 35 33 37 2e 33 36 20 28 4b 48 54 4d 4c 2c 20 6c 69 6b 65 20 47 65 63 6b 6f 29 20 43 68 72 6f 6d 65 2f 33 36 2e 30 2e 31 39 38 35 2e 31 32 35 20 53 61 66 61 72 69 2f 35 33 37 2e 33 36}
		$s4 = {43 52 54 44 4c 4c 2e 44 4c 4c}
		$s5 = {5c 73 79 73 6e 61 74 69 76 65}
		$s6 = {49 6e 74 65 72 6e 65 74 4f 70 65 6e 41 20 63 6f 6f 6c 69 6f 2c 20 74 72 79 69 6e 67 20 6f 70 65 6e 20 25 73}

	condition:
		uint16( 0 ) == 0x5a4d and filesize < 2500KB and 5 of them
}

