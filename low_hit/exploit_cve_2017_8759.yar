rule CVE_2017_8759_Mal_HTA : hardened
{
	meta:
		description = "Detects malicious files related to CVE-2017-8759 - file cmd.hta"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://github.com/Voulnet/CVE-2017-8759-Exploit-sample"
		date = "2017-09-14"
		hash1 = "fee2ab286eb542c08fdfef29fabf7796a0a91083a0ee29ebae219168528294b5"
		id = "e53b5149-fc94-5da5-8e35-7f09a9cd79fd"

	strings:
		$x1 = {45 72 72 6f 72 20 3d 20 50 72 6f 63 65 73 73 2e 43 72 65 61 74 65 28 22 70 6f 77 65 72 73 68 65 6c 6c 20 2d 6e 6f 70 20 63 6d 64 2e 65 78 65 20 2f 63}

	condition:
		( uint16( 0 ) == 0x683c and filesize < 1KB and all of them )
}

rule CVE_2017_8759_Mal_Doc : hardened
{
	meta:
		description = "Detects malicious files related to CVE-2017-8759 - file Doc1.doc"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://github.com/Voulnet/CVE-2017-8759-Exploit-sample"
		date = "2017-09-14"
		modified = "2023-11-21"
		hash1 = "6314c5696af4c4b24c3a92b0e92a064aaf04fd56673e830f4d339b8805cc9635"
		id = "48587c13-7661-5987-8331-732115f7823b"

	strings:
		$s1 = {((73 6f 61 70 3a 77 73 64 6c 3d 68 74 74 70 3a 2f 2f) | (73 00 6f 00 61 00 70 00 3a 00 77 00 73 00 64 00 6c 00 3d 00 68 00 74 00 74 00 70 00 3a 00 2f 00 2f 00))}
		$s2 = {((73 6f 61 70 3a 77 73 64 6c 3d 68 74 74 70 73 3a 2f 2f) | (73 00 6f 00 61 00 70 00 3a 00 77 00 73 00 64 00 6c 00 3d 00 68 00 74 00 74 00 70 00 73 00 3a 00 2f 00 2f 00))}
		$s3 = {((73 6f 61 70 3a 77 73 64 6c 3d 68 74 74 70 25 33) | (73 00 6f 00 61 00 70 00 3a 00 77 00 73 00 64 00 6c 00 3d 00 68 00 74 00 74 00 70 00 25 00 33 00))}
		$s4 = {((73 6f 61 70 3a 77 73 64 6c 3d 68 74 74 70 73 25 33) | (73 00 6f 00 61 00 70 00 3a 00 77 00 73 00 64 00 6c 00 3d 00 68 00 74 00 74 00 70 00 73 00 25 00 33 00))}
		$c1 = {50 00 72 00 6f 00 6a 00 65 00 63 00 74 00 2e 00 54 00 68 00 69 00 73 00 44 00 6f 00 63 00 75 00 6d 00 65 00 6e 00 74 00 2e 00 41 00 75 00 74 00 6f 00 4f 00 70 00 65 00 6e 00}

	condition:
		uint16( 0 ) == 0xcfd0 and filesize < 500KB and ( 1 of ( $s* ) and $c1 )
}

rule CVE_2017_8759_SOAP_via_JS : hardened limited
{
	meta:
		description = "Detects SOAP WDSL Download via JavaScript"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://twitter.com/buffaloverflow/status/907728364278087680"
		date = "2017-09-14"
		score = 60
		id = "9e96cea3-4282-5f25-ad37-51bd69258790"

	strings:
		$s1 = {((47 65 74 4f 62 6a 65 63 74 28 22 73 6f 61 70 3a 77 73 64 6c 3d 68 74 74 70 73 3a 2f 2f) | (47 00 65 00 74 00 4f 00 62 00 6a 00 65 00 63 00 74 00 28 00 22 00 73 00 6f 00 61 00 70 00 3a 00 77 00 73 00 64 00 6c 00 3d 00 68 00 74 00 74 00 70 00 73 00 3a 00 2f 00 2f 00))}
		$s2 = {((47 65 74 4f 62 6a 65 63 74 28 22 73 6f 61 70 3a 77 73 64 6c 3d 68 74 74 70 3a 2f 2f) | (47 00 65 00 74 00 4f 00 62 00 6a 00 65 00 63 00 74 00 28 00 22 00 73 00 6f 00 61 00 70 00 3a 00 77 00 73 00 64 00 6c 00 3d 00 68 00 74 00 74 00 70 00 3a 00 2f 00 2f 00))}

	condition:
		( filesize < 3KB and 1 of them )
}

rule CVE_2017_8759_SOAP_Excel : hardened limited
{
	meta:
		description = "Detects malicious files related to CVE-2017-8759"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://twitter.com/buffaloverflow/status/908455053345869825"
		date = "2017-09-15"
		score = 60
		id = "940ec910-49a4-5271-97e4-8536db271b80"

	strings:
		$s1 = {((7c 27 73 6f 61 70 3a 77 73 64 6c 3d) | (7c 00 27 00 73 00 6f 00 61 00 70 00 3a 00 77 00 73 00 64 00 6c 00 3d 00))}

	condition:
		( filesize < 300KB and 1 of them )
}

rule CVE_2017_8759_SOAP_txt : hardened
{
	meta:
		description = "Detects malicious file in releation with CVE-2017-8759 - file exploit.txt"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://github.com/Voulnet/CVE-2017-8759-Exploit-sample"
		date = "2017-09-14"
		hash1 = "840ad14e29144be06722aff4cc04b377364eeed0a82b49cc30712823838e2444"
		id = "36474420-4fa9-5264-a46b-bb2434624710"

	strings:
		$s1 = /<soap:address location="http[s]?:\/\/[^"]{8,140}.hta"/ ascii wide
		$s2 = /<soap:address location="http[s]?:\/\/[^"]{8,140}mshta.exe"/ ascii wide

	condition:
		( filesize < 200KB and 1 of them )
}

rule CVE_2017_8759_WSDL_in_RTF : hardened limited
{
	meta:
		description = "Detects malicious RTF file related CVE-2017-8759"
		author = "Security Doggo @xdxdxdxdoa"
		reference = "https://twitter.com/xdxdxdxdoa/status/908665278199996416"
		date = "2017-09-15"
		id = "daaa5489-af96-5a69-b2dd-81406c0a1edc"

	strings:
		$doc = {64 30 63 66 31 31 65 30 61 31 62 31 31 61 65 31}
		$obj = {5c 6f 62 6a 75 70 64 61 74 65}
		$wsdl = {37 37 30 30 37 33 30 30 36 34 30 30 36 63 30 30 33 64 30 30}
		$http1 = {36 38 30 30 37 34 30 30 37 34 30 30 37 30 30 30 33 61 30 30 32 66 30 30 32 66 30 30}
		$http2 = {36 38 30 30 37 34 30 30 37 34 30 30 37 30 30 30 37 33 30 30 33 61 30 30 32 66 30 30 32 66 30 30}
		$http3 = {36 36 30 30 37 34 30 30 37 30 30 30 33 61 30 30 32 66 30 30 32 66 30 30}

	condition:
		uint32be( 0 ) == 0x7B5C7274 and $obj and $doc and $wsdl and 1 of ( $http* )
}

