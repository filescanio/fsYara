rule Win7Elevatev2 : hardened
{
	meta:
		description = "Detects Win7Elevate - Windows UAC bypass utility"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "http://www.pretentiousname.com/misc/W7E_Source/Win7Elevate_Inject.cpp.html"
		date = "2015-05-14"
		hash1 = "4f53ff6a04e46eda92b403faf42219a545c06c29"
		hash2 = "808d04c187a524db402c5b2be17ce799d2654bd1"
		score = 60
		id = "af092d16-ca95-5985-822a-50457c9cbcc9"

	strings:
		$x1 = {54 00 68 00 69 00 73 00 20 00 70 00 72 00 6f 00 67 00 72 00 61 00 6d 00 20 00 61 00 74 00 74 00 65 00 6d 00 70 00 74 00 73 00 20 00 74 00 6f 00 20 00 62 00 79 00 70 00 61 00 73 00 73 00 20 00 57 00 69 00 6e 00 64 00 6f 00 77 00 73 00 20 00 37 00 27 00 73 00 20 00 64 00 65 00 66 00 61 00 75 00 6c 00 74 00 20 00 55 00 41 00 43 00 20 00 73 00 65 00 74 00 74 00 69 00 6e 00 67 00 73 00 20 00 74 00 6f 00 20 00 72 00 75 00 6e 00 20 00}
		$x2 = {57 69 6e 37 45 6c 65 76 61 74 65 56 32 5c 78 36 34 5c 52 65 6c 65 61 73 65 5c}
		$x3 = {52 00 75 00 6e 00 20 00 74 00 68 00 65 00 20 00 63 00 6f 00 6d 00 6d 00 61 00 6e 00 64 00 20 00 6e 00 6f 00 72 00 6d 00 61 00 6c 00 6c 00 79 00 20 00 28 00 77 00 69 00 74 00 68 00 6f 00 75 00 74 00 20 00 63 00 6f 00 64 00 65 00 20 00 69 00 6e 00 6a 00 65 00 63 00 74 00 69 00 6f 00 6e 00 29 00}
		$x4 = {49 00 6e 00 6a 00 65 00 63 00 74 00 20 00 66 00 69 00 6c 00 65 00 20 00 63 00 6f 00 70 00 79 00 20 00 26 00 26 00 20 00 65 00 6c 00 65 00 76 00 61 00 74 00 65 00 20 00 63 00 6f 00 6d 00 6d 00 61 00 6e 00 64 00}
		$x5 = {68 00 74 00 74 00 70 00 3a 00 2f 00 2f 00 77 00 77 00 77 00 2e 00 70 00 72 00 65 00 74 00 65 00 6e 00 74 00 69 00 6f 00 75 00 73 00 6e 00 61 00 6d 00 65 00 2e 00 63 00 6f 00 6d 00 2f 00 6d 00 69 00 73 00 63 00 2f 00 77 00 69 00 6e 00 37 00 5f 00 75 00 61 00 63 00 5f 00 77 00 68 00 69 00 74 00 65 00 6c 00 69 00 73 00 74 00 32 00 2e 00 68 00 74 00 6d 00 6c 00}
		$x6 = {46 00 6f 00 72 00 20 00 69 00 6e 00 6a 00 65 00 63 00 74 00 69 00 6f 00 6e 00 2c 00 20 00 70 00 69 00 63 00 6b 00 20 00 61 00 6e 00 79 00 20 00 75 00 6e 00 65 00 6c 00 65 00 76 00 61 00 74 00 65 00 64 00 20 00 57 00 69 00 6e 00 64 00 6f 00 77 00 73 00 20 00 70 00 72 00 6f 00 63 00 65 00 73 00 73 00 20 00 77 00 69 00 74 00 68 00 20 00 41 00 53 00 4c 00 52 00 20 00 6f 00 6e 00 3a 00}
		$s1 = {5c 00 63 00 6d 00 64 00 2e 00 65 00 78 00 65 00}
		$s2 = {72 00 75 00 6e 00 61 00 73 00}
		$s3 = {65 00 78 00 70 00 6c 00 6f 00 72 00 65 00 72 00 2e 00 65 00 78 00 65 00}
		$s4 = {43 00 6f 00 75 00 6c 00 64 00 6e 00 27 00 74 00 20 00 6c 00 6f 00 61 00 64 00 20 00 6b 00 65 00 72 00 6e 00 65 00 6c 00 33 00 32 00 2e 00 64 00 6c 00 6c 00}
		$s5 = {43 00 52 00 59 00 50 00 54 00 42 00 41 00 53 00 45 00 2e 00 64 00 6c 00 6c 00}
		$s6 = {73 00 68 00 65 00 6c 00 6c 00 33 00 32 00 2e 00 64 00 6c 00 6c 00}
		$s7 = {53 68 65 6c 6c 45 78 65 63 75 74 65 45 78}
		$s8 = {43 4f 4d 43 54 4c 33 32 2e 64 6c 6c}
		$s9 = {53 68 65 6c 6c 45 78 65 63 75 74 65 45 78}
		$s10 = {48 65 61 70 41 6c 6c 6f 63}

	condition:
		uint16( 0 ) == 0x5a4d and ( 1 of ( $x* ) or all of ( $s* ) )
}

rule UACME_Akagi : hardened
{
	meta:
		description = "Rule to detect UACMe - abusing built-in Windows AutoElevate backdoor"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://github.com/hfiref0x/UACME"
		date = "2015-05-14"
		hash1 = "edd2138bbd9e76c343051c6dc898054607f2040a"
		hash2 = "e3a919ccc2e759e618208ededa8a543954d49f8a"
		score = 60
		id = "7979129e-99a3-522a-8285-9061e1e2bd41"

	strings:
		$x1 = {55 00 41 00 43 00 4d 00 65 00 20 00 69 00 6e 00 6a 00 65 00 63 00 74 00 65 00 64 00 2c 00 20 00 46 00 75 00 62 00 75 00 6b 00 69 00 20 00 61 00 74 00 20 00 79 00 6f 00 75 00 72 00 20 00 73 00 65 00 72 00 76 00 69 00 63 00 65 00 2e 00}
		$x3 = {25 00 74 00 65 00 6d 00 70 00 25 00 5c 00 48 00 69 00 62 00 69 00 6b 00 69 00 2e 00 64 00 6c 00 6c 00}
		$x4 = {5b 00 55 00 43 00 4d 00 5d 00 20 00 43 00 61 00 6e 00 6e 00 6f 00 74 00 20 00 77 00 72 00 69 00 74 00 65 00 20 00 74 00 6f 00 20 00 74 00 68 00 65 00 20 00 74 00 61 00 72 00 67 00 65 00 74 00 20 00 70 00 72 00 6f 00 63 00 65 00 73 00 73 00 20 00 6d 00 65 00 6d 00 6f 00 72 00 79 00 2e 00}
		$s1 = {25 00 73 00 79 00 73 00 74 00 65 00 6d 00 72 00 6f 00 6f 00 74 00 25 00 5c 00 73 00 79 00 73 00 74 00 65 00 6d 00 33 00 32 00 5c 00 63 00 6d 00 64 00 2e 00 65 00 78 00 65 00}
		$s2 = {44 00 3a 00 28 00 41 00 3b 00 3b 00 47 00 41 00 3b 00 3b 00 3b 00 57 00 44 00 29 00}
		$s3 = {25 00 73 00 79 00 73 00 74 00 65 00 6d 00 72 00 6f 00 6f 00 74 00 25 00 5c 00 73 00 79 00 73 00 74 00 65 00 6d 00 33 00 32 00 5c 00 73 00 79 00 73 00 70 00 72 00 65 00 70 00 5c 00 73 00 79 00 73 00 70 00 72 00 65 00 70 00 2e 00 65 00 78 00 65 00}
		$s4 = {2f 00 63 00 20 00 77 00 75 00 73 00 61 00 20 00 25 00 77 00 73 00 20 00 2f 00 65 00 78 00 74 00 72 00 61 00 63 00 74 00 3a 00 25 00 25 00 77 00 69 00 6e 00 64 00 69 00 72 00 25 00 25 00 5c 00 73 00 79 00 73 00 74 00 65 00 6d 00 33 00 32 00}
		$s5 = {46 75 62 75 6b 69 2e 64 6c 6c}
		$l1 = {6e 74 64 6c 6c 2e 64 6c 6c}
		$l2 = {43 61 62 69 6e 65 74 2e 64 6c 6c}
		$l3 = {47 65 74 50 72 6f 63 65 73 73 48 65 61 70}
		$l4 = {57 72 69 74 65 50 72 6f 63 65 73 73 4d 65 6d 6f 72 79}
		$l5 = {53 68 65 6c 6c 45 78 65 63 75 74 65 45 78}

	condition:
		(1 of ( $x* ) ) or ( 3 of ( $s* ) and all of ( $l* ) )
}

rule UACElevator : hardened
{
	meta:
		description = "UACElevator bypassing UAC - file UACElevator.exe"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://github.com/MalwareTech/UACElevator"
		date = "2015-05-14"
		hash = "fd29d5a72d7a85b7e9565ed92b4d7a3884defba6"
		id = "629b1a92-726d-5713-ae3d-74cc8a1e52ad"

	strings:
		$x1 = {5c 55 41 43 45 6c 65 76 61 74 6f 72 2e 70 64 62}
		$s1 = {25 75 73 65 72 70 72 6f 66 69 6c 65 25 5c 44 6f 77 6e 6c 6f 61 64 73 5c 64 77 6d 61 70 69 2e 64 6c 6c}
		$s2 = {25 77 69 6e 64 69 72 25 5c 73 79 73 74 65 6d 33 32 5c 64 77 6d 61 70 69 2e 64 6c 6c}
		$s3 = {49 6e 66 65 63 74 69 6f 6e 20 6d 6f 64 75 6c 65 3a 20 25 73}
		$s4 = {43 6f 75 6c 64 20 6e 6f 74 20 73 61 76 65 20 6d 6f 64 75 6c 65 20 74 6f 20 25 73}
		$s5 = {25 73 25 73 25 70 25 73 25 6c 64 25 73 25 64 25 73}
		$s6 = {53 74 61 63 6b 20 61 72 65 61 20 61 72 6f 75 6e 64 20 5f 61 6c 6c 6f 63 61 20 6d 65 6d 6f 72 79 20 72 65 73 65 72 76 65 64 20 62 79 20 74 68 69 73 20 66 75 6e 63 74 69 6f 6e 20 69 73 20 63 6f 72 72 75 70 74 65 64}
		$s7 = {53 74 61 63 6b 20 61 72 6f 75 6e 64 20 74 68 65 20 76 61 72 69 61 62 6c 65 20 27}
		$s8 = {4d 00 53 00 56 00 43 00 52 00 31 00 32 00 30 00 44 00 2e 00 64 00 6c 00 6c 00}
		$s9 = {41 64 64 72 65 73 73 3a 20 30 78}

	condition:
		uint16( 0 ) == 0x5a4d and filesize < 172KB and ( $x1 or 8 of ( $s* ) )
}

rule s4u : hardened
{
	meta:
		description = "Detects s4u executable which allows the creation of a cmd.exe with the context of any user without requiring the password. - file s4u.exe"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://github.com/aurel26/s-4-u-for-windows"
		date = "2015-06-05"
		hash = "cfc18f3d5306df208461459a8e667d89ce44ed77"
		score = 50
		id = "0d746311-56fe-538c-946c-3a3dd1603adc"

	strings:
		$x0 = {73 34 75 2e 65 78 65 20 44 6f 6d 61 69 6e 5c 55 73 65 72 6e 61 6d 65 20 5b 45 78 74 72 61 20 53 49 44 5d}
		$x1 = {5c 52 65 6c 65 61 73 65 5c 73 34 75 2e 70 64 62}
		$s0 = {43 72 65 61 74 65 50 72 6f 63 65 73 73 41 73 55 73 65 72 20 66 61 69 6c 65 64 20 28 65 72 72 6f 72 20 25 75 29 2e}
		$s1 = {47 65 74 54 6f 6b 65 6e 49 6e 66 6f 72 6d 61 74 69 6f 6e 20 66 61 69 6c 65 64 20 28 65 72 72 6f 72 3a 20 25 75 29 2e}
		$s2 = {4c 73 61 4c 6f 67 6f 6e 55 73 65 72 20 66 61 69 6c 65 64 20 28 65 72 72 6f 72 20 30 78 25 78 29 2e}
		$s3 = {4c 73 61 4c 6f 67 6f 6e 55 73 65 72 3a 20 4f 4b 2c 20 4c 6f 67 6f 6e 49 64 3a 20 30 78 25 78 2d 30 78 25 78}
		$s4 = {4c 6f 6f 6b 75 70 50 72 69 76 69 6c 65 67 65 56 61 6c 75 65 20 66 61 69 6c 65 64 20 28 65 72 72 6f 72 3a 20 25 75 29 2e}
		$s5 = {54 68 65 20 74 6f 6b 65 6e 20 64 6f 65 73 20 6e 6f 74 20 68 61 76 65 20 74 68 65 20 73 70 65 63 69 66 69 65 64 20 70 72 69 76 69 6c 65 67 65 20 28 25 53 29 2e}
		$s6 = {55 6e 61 62 6c 65 20 74 6f 20 70 61 72 73 65 20 63 6f 6d 6d 61 6e 64 20 6c 69 6e 65 2e}
		$s7 = {55 6e 61 62 6c 65 20 74 6f 20 66 69 6e 64 20 6c 6f 67 6f 6e 20 53 49 44 2e}
		$s8 = {41 64 6a 75 73 74 54 6f 6b 65 6e 50 72 69 76 69 6c 65 67 65 73 20 66 61 69 6c 65 64 20 28 65 72 72 6f 72 3a 20 25 75 29 2e}
		$s9 = {41 64 6a 75 73 74 54 6f 6b 65 6e 50 72 69 76 69 6c 65 67 65 73 20 28 25 53 29 3a 20 4f 4b}
		$g1 = {25 00 73 00 79 00 73 00 74 00 65 00 6d 00 72 00 6f 00 6f 00 74 00 25 00 5c 00 73 00 79 00 73 00 74 00 65 00 6d 00 33 00 32 00 5c 00 63 00 6d 00 64 00 2e 00 65 00 78 00 65 00}
		$g2 = {53 00 65 00 54 00 63 00 62 00 50 00 72 00 69 00 76 00 69 00 6c 00 65 00 67 00 65 00}
		$g3 = {77 00 69 00 6e 00 73 00 74 00 61 00 30 00 5c 00 64 00 65 00 66 00 61 00 75 00 6c 00 74 00}
		$g4 = {2e 72 73 72 63}
		$g5 = {48 65 61 70 41 6c 6c 6f 63}
		$g6 = {47 65 74 43 75 72 72 65 6e 74 50 72 6f 63 65 73 73}
		$g7 = {48 65 61 70 46 72 65 65}
		$g8 = {47 65 74 50 72 6f 63 65 73 73 48 65 61 70}
		$g9 = {45 78 70 61 6e 64 45 6e 76 69 72 6f 6e 6d 65 6e 74 53 74 72 69 6e 67 73}
		$g10 = {43 6f 6e 76 65 72 74 53 74 72 69 6e 67 53 69 64 54 6f 53 69 64}
		$g11 = {4c 6f 6f 6b 75 70 50 72 69 76 69 6c 65 67 65 56 61 6c 75 65}
		$g12 = {41 6c 6c 6f 63 61 74 65 4c 6f 63 61 6c 6c 79 55 6e 69 71 75 65 49 64}
		$g13 = {41 44 56 41 50 49 33 32 2e 64 6c 6c}
		$g14 = {4c 73 61 4c 6f 6f 6b 75 70 41 75 74 68 65 6e 74 69 63 61 74 69 6f 6e 50 61 63 6b 61 67 65}
		$g15 = {53 65 63 75 72 33 32 2e 64 6c 6c}
		$g16 = {4d 53 56 43 52 31 32 30 2e 64 6c 6c}

	condition:
		uint16( 0 ) == 0x5a4d and filesize < 60KB and ( 1 of ( $x* ) or all of ( $s* ) or all of ( $g* ) )
}

rule UACME_Akagi_2 : hardened
{
	meta:
		description = "Detects Windows User Account Control Bypass - from files Akagi32.exe, Akagi64.exe"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		author = "Florian Roth (Nextron Systems)"
		reference = "https://github.com/hfiref0x/UACME"
		date = "2017-02-03"
		hash1 = "caf744d38820accb48a6e50216e547ed2bb3979604416dbcfcc991ce5e18f4ca"
		hash2 = "609e9b15114e54ffc40c05a8980cc90f436a4a77c69f3e32fe391c0b130ff1c5"
		score = 80
		id = "1177d663-1081-5d17-9dd7-1218d95d90f7"

	strings:
		$x1 = {55 00 73 00 61 00 67 00 65 00 3a 00 20 00 41 00 6b 00 61 00 67 00 69 00 2e 00 65 00 78 00 65 00 20 00 5b 00 4d 00 65 00 74 00 68 00 6f 00 64 00 5d 00 20 00 5b 00 4f 00 70 00 74 00 69 00 6f 00 6e 00 61 00 6c 00 50 00 61 00 72 00 61 00 6d 00 54 00 6f 00 45 00 78 00 65 00 63 00 75 00 74 00 65 00 5d 00}
		$x2 = {5b 00 55 00 43 00 4d 00 5d 00 20 00 54 00 61 00 72 00 67 00 65 00 74 00 20 00 66 00 69 00 6c 00 65 00 20 00 61 00 6c 00 72 00 65 00 61 00 64 00 79 00 20 00 65 00 78 00 69 00 73 00 74 00 73 00 2c 00 20 00 61 00 62 00 6f 00 72 00 74 00}
		$s1 = {4d 00 41 00 43 00 48 00 49 00 4e 00 45 00 5c 00 53 00 4f 00 46 00 54 00 57 00 41 00 52 00 45 00 5c 00 4d 00 69 00 63 00 72 00 6f 00 73 00 6f 00 66 00 74 00 5c 00 57 00 69 00 6e 00 64 00 6f 00 77 00 73 00 20 00 4e 00 54 00 5c 00 43 00 75 00 72 00 72 00 65 00 6e 00 74 00 56 00 65 00 72 00 73 00 69 00 6f 00 6e 00 5c 00 49 00 6d 00 61 00 67 00 65 00 20 00 46 00 69 00 6c 00 65 00 20 00 45 00 78 00 65 00 63 00 75 00 74 00 69 00 6f 00 6e 00 20 00 4f 00 70 00 74 00 69 00 6f 00 6e 00 73 00}
		$s2 = {41 00 6b 00 61 00 67 00 69 00 2e 00 65 00 78 00 65 00}
		$s3 = {45 00 6c 00 65 00 76 00 61 00 74 00 69 00 6f 00 6e 00 3a 00 41 00 64 00 6d 00 69 00 6e 00 69 00 73 00 74 00 72 00 61 00 74 00 6f 00 72 00 21 00 6e 00 65 00 77 00 3a 00 7b 00 33 00 41 00 44 00 30 00 35 00 35 00 37 00 35 00 2d 00 38 00 38 00 35 00 37 00 2d 00 34 00 38 00 35 00 30 00 2d 00 39 00 32 00 37 00 37 00 2d 00 31 00 31 00 42 00 38 00 35 00 42 00 44 00 42 00 38 00 45 00 30 00 39 00 7d 00}
		$s4 = {2f 00 63 00 20 00 77 00 75 00 73 00 61 00 20 00 25 00 77 00 73 00 20 00 2f 00 65 00 78 00 74 00 72 00 61 00 63 00 74 00 3a 00 25 00 25 00 77 00 69 00 6e 00 64 00 69 00 72 00 25 00 25 00 5c 00 73 00 79 00 73 00 74 00 65 00 6d 00 33 00 32 00 5c 00 73 00 79 00 73 00 70 00 72 00 65 00 70 00}
		$s5 = {2f 00 63 00 20 00 77 00 75 00 73 00 61 00 20 00 25 00 77 00 73 00 20 00 2f 00 65 00 78 00 74 00 72 00 61 00 63 00 74 00 3a 00 25 00 25 00 77 00 69 00 6e 00 64 00 69 00 72 00 25 00 25 00 5c 00 73 00 79 00 73 00 74 00 65 00 6d 00 33 00 32 00 5c 00 6d 00 69 00 67 00 77 00 69 00 7a 00}
		$s6 = {6c 6f 61 64 46 72 6f 6d 3d 22 25 73 79 73 74 65 6d 72 6f 6f 74 25 5c 73 79 73 74 65 6d 33 32 5c 73 79 73 70 72 65 70 5c 63 72 79 70 74 62 61 73 65 2e 44 4c 4c 22}

	condition:
		( uint16( 0 ) == 0x5a4d and filesize < 900KB and ( 1 of ( $x* ) or 3 of ( $s* ) ) ) or ( 6 of them )
}

